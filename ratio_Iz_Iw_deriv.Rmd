---
title: "Determination of d(Iz/(Iw+Iz))/dt"
author: "Jakub"
date: "24 října 2016"
output: html_document
---

<center> <h3> Definition of the model </h3> </center>

```{r, out.width = "200px", echo=FALSE, cache=TRUE, fig.align='center'}
knitr::include_graphics("C:/Users/Jakub/Desktop/Figures/Mechanistic model of AMR spread.png")
```

$$
\begin{aligned}
\frac{dS}{dt} &=- \beta_w I_wS - \beta_z I_z S + \gamma  I_z + \gamma(1 - \varepsilon)I_w + \gamma `  \varepsilon  I_w \\
\frac{dI_w}{dt} &=\beta_w I_wS + (1-\varepsilon)\beta_wI_wI_z - \gamma(1 - \varepsilon)I_w - \gamma `  \varepsilon  I_w - \varepsilon\beta_zI_zI_w - \rho\varepsilon I_w \\
\frac{dI_z}{dt} &=\beta_z I_zS + \varepsilon\beta_zI_zI_w + \rho\varepsilon I_w - \gamma  I_z - (1-\varepsilon)\beta_wI_wI_z \\
\end{aligned}
$$

<center> <h3> State variables </h3> </center>

Name of state variable | Description
-----|--------------------------------------------------
$S$ | proportion of population that is susceptible
$I_w$ | proportion of population that is infected with sensitive strain
$I_z$ | proportion of population that is infected with resistant strain


<center> <h3> Parameters </h3> </center>

Name of Parameter | Description
-----|--------------------------------------------------
$\beta_w$ | transmission rate of sensitive strain
$\beta_z$ | transmission rate of resistant strain
$\varepsilon$ | proportion of infected people treated with antibiotics, supposedly strongly correlated to AMU
$\gamma$ | innate recovery rate (relative to $I_z$ generally and to $I_w$ | not treated with antibiotics)
$\gamma '$ | recovery rate of $I_w$ when treated with antibiotics
$\rho$ | proportion of treatment failures in $I_w$ (comprehensing _de novo_ mutations, outcompetition of major sensitive strain by minor resistant one and horizontal transfer)




<center> <h3> Derivatives </h3> </center>
$$
\begin{aligned}
\frac{dp}{dt} &= p(1-q)\beta_z - p(1-q)[(1-p)\beta_w + p\beta_z] - p(1-p)[\gamma-\left( \gamma(1-\varepsilon)+\gamma'\varepsilon\right)]+(1-p)[-pq\left((1-\varepsilon)\beta_w-\varepsilon\beta_z\right)+\rho\varepsilon]  \\
&= -p(1-q)(1-p)(\beta_w-\beta_z) - p(1-p)[\gamma-\left( \gamma(1-\varepsilon)+\gamma'\varepsilon\right)]+(1-p)[-pq\left((1-\varepsilon)\beta_w-\varepsilon\beta_z\right)+\rho\varepsilon]  \\
\\
\frac{dq}{dt} &= q[(1-q)\left((1-p)\beta_w+p\beta_z)\right) - \gamma - \varepsilon (1-p)(\gamma'-\gamma) ]
\end{aligned}
$$


``` {r expr, include=FALSE}
#dp/dt &= p \left( \varepsilon(\gamma` - \gamma) + (\beta_z-\beta_w)\right) + pq \left(-\beta_z(1-\varepsilon) + \beta_w\varepsilon \right) + p^{2} \left((\beta_w-\beta_z)+\varepsilon(\gamma-\gamma`) \right) + p^{2}q\left(\beta_z (1-\varepsilon) - \beta_w\varepsilon \right) +  (1-p)\rho\varepsilon \\
#&=p(1-p)\left (\varepsilon(\gamma` - \gamma) +(\beta_z-\beta_w) \right) + pq(1-p) \left( -\beta_z(1-\varepsilon) + \beta_w \varepsilon \right) + (1-p)(\rho\varepsilon) \\
#&= (1-p) [\rho\varepsilon + pq\left( -\beta_z(1-\varepsilon) + \beta_w \varepsilon \right) + p\left(\varepsilon(\gamma` - \gamma) +(\beta_z-\beta_w)\right) ]
```
Where:
$$
\begin{aligned}
q=I_z+I_w \\
p=\frac{I_z}{I_z+I_w}
\end{aligned}
$$

```{r param, include=FALSE}


library(deSolve)

options("scipen" = 10)
N <- 1
a <- 10000 #time span
m <- 1 #time step

pbeta_w <- 0.04 #transmission parameter of Iw
pbeta_z <- 0.015 #transmission parameter of Iz

pgammaa <- 0.01 #innate recovery rate
pgamma_tilt <- 0.1 #recovery rate of Iw when treated by antibiotics


prho <- 0.05 #probability of clinical failure

peps <- 0.10 #initial value of the ratio of treated patients

pc_zw <- 0.5  # competitivity ratio : probability of replacement of Iz by Iw when reinfected and not treated
pc_wz <- 0.02 # competitivity ratio : probability of replacement of Iw by Iz when reinfected and not treated



prhoi <- seq(0,0.10,by=0.001)
pepsi <- seq(0,1,by=0.01)
pc_wzi <- seq(0,0.10, by=0.001)
pc_zwi <- seq(0,0.80, by=0.001)

prop <- 0.01 



conv_crit <- 0.00001

```

```{r trial, include=FALSE, cache=TRUE}
parameters <- c(beta_w=pbeta_w, beta_z=pbeta_z, gamma=pgammaa, gamma_prim=pgamma_tilt, eps=peps, rho=prho)

state <- c(S=1-2*prop, Iw=prop, Iz=prop, Iz_div_Inf=0.5, Iz_plus_Iw=2*prop)

times <- seq(0, a, by=m)

SIS=function(times, state, parameters){
  with(as.list(c(state,parameters)),
       {dS = - beta_w*Iw*S - beta_z*Iz*S + gamma*(1-eps)*Iw + gamma_prim*eps*Iw + gamma*Iz
        dIw = beta_w*Iw*S + (1-eps)*beta_w*Iw*Iz - eps*beta_z*Iz*Iw - rho*eps*Iw - gamma*(1-eps)*Iw - gamma_prim*eps*Iw
        dIz = beta_z*Iz*S + eps*beta_z*Iz*Iw + rho*eps*Iw - (1-eps)*beta_w*Iw*Iz - gamma*Iz
        dIz_div_Inf = (Iz/(Iw+Iz))*(1-Iw-Iz)*((1-(Iz/(Iw+Iz)))*beta_z-(1-(Iz/(Iw+Iz)))*beta_w)-(Iz/(Iw+Iz))*(gamma*(1-(Iz/(Iw+Iz)))-(gamma*(1-eps)+gamma_prim*eps)*(1-(Iz/(Iw+Iz)))) - (1-(Iz/(Iw+Iz)))*(Iz*((1-eps)*beta_w-eps*beta_z)-rho*eps)
        dIz_plus_Iw = (Iw+Iz)*((1-Iw-Iz)*((1-(Iz/(Iw+Iz)))*beta_w + (Iz/(Iw+Iz))*beta_z) - gamma*(Iz/(Iw+Iz)) - gamma*(1-eps)*(1-(Iz/(Iw+Iz))) - gamma_prim*eps*(1-(Iz/(Iw+Iz))) )
        list(c(dS, dIw, dIz, dIz_div_Inf, dIz_plus_Iw))
        })
}
#dIz_div_Inf = -beta_z*Iz*(1-eps)+eps*beta_w*Iz+(1/(Iz+Iw))*(beta_z*Iz*Iz*(1-eps)+Iz*(beta_z-beta_w)-Iz*Iz*beta_w*eps+Iz*eps*(gamma_prim-gamma)) + (1/((Iz+Iw)*(Iz+Iw)))*(Iz*Iz*(beta_w-beta_z)+Iz*Iz*eps*(gamma-gamma_prim))+rho*eps*Iw/(Iz+Iw)
#dIz_div_Inf = (1/(Iz+Iw))*(beta_z*Iz*(1-Iz-Iw)+eps*beta_z*Iw*Iz+rho*eps*Iw-gamma*Iz-(1-eps)*beta_w*Iw*Iz)+(1/((Iw+Iz)*(Iw+Iz)))*Iz*(-beta_w*Iw*(1-Iz-Iw)-beta_z*Iz*(1-Iz-Iw)+gamma*Iz+gamma*(1-eps)*Iw+gamma_prim*eps*Iw)

out=as.data.frame(
  ode(y=state, times=times, func=SIS, parms=parameters)
)

require(plyr)
out2 <- cbind(out, mutate(out, p=out$Iz/(out$Iw+out$Iz), q=out$Iw+out$Iz))



```

<center> <h3> Steady states when varying AMU or rate of acquisition of AMR </h3> </center>
